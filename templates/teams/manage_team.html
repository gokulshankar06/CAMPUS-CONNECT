{% extends 'base.html' %}

{% block title %}{{ team.name }} - Team Management - CampusConnect{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Team Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('events.view_event', event_id=event.id) }}">{{ event.title }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ team.name }}</li>
                </ol>
            </nav>
            <div class="d-flex align-items-center">
                <div class="me-3">
                    {% if team.avatar %}
                        <img src="{{ url_for('static', filename='uploads/teams/' + team.avatar) }}" 
                             class="rounded-circle" width="80" height="80" alt="{{ team.name }}">
                    {% else %}
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 80px; height: 80px; background-color: {{ team.color or '#6c757d' }}; color: white; font-size: 2rem;">
                            {{ team.name[0]|upper }}
                        </div>
                    {% endif %}
                </div>
                <div>
                    <h1 class="h3 mb-1">{{ team.name }}</h1>
                    <div class="d-flex align-items-center text-muted">
                        <span class="me-3">
                            <i class="bi bi-people-fill me-1"></i> {{ team.members|length }}{% if team.max_members %}/{{ team.max_members }}{% endif %} members
                        </span>
                        <span class="badge {% if team.looking_for_members %}bg-success{% else %}bg-secondary{% endif %} me-3">
                            {% if team.looking_for_members %}Looking for members{% else %}Not recruiting{% endif %}
                        </span>
                        <span class="badge bg-{{ 'success' if team.is_active else 'secondary' }}">
                            {{ 'Active' if team.is_active else 'Inactive' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        {% if current_user.id == team.leader_id or current_user.is_admin %}
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-gear-fill"></i> Manage Team
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editTeamModal">
                    <i class="bi bi-pencil me-2"></i>Edit Team
                </a></li>
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#inviteMemberModal">
                    <i class="bi bi-person-plus me-2"></i>Invite Members
                </a></li>
                {% if team.looking_for_members %}
                <li><a class="dropdown-item" href="#" id="toggleRecruitment" data-status="0">
                    <i class="bi bi-person-x me-2"></i>Close Recruitment
                </a></li>
                {% else %}
                <li><a class="dropdown-item" href="#" id="toggleRecruitment" data-status="1">
                    <i class="bi bi-person-plus me-2"></i>Open for Recruitment
                </a></li>
                {% endif %}
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#disbandTeamModal">
                    <i class="bi bi-trash me-2"></i>Disband Team
                </a></li>
            </ul>
        </div>
        {% endif %}
    </div>

    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Team Overview -->
            <div class="card mb-4">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="teamTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" 
                                    data-bs-target="#overview" type="button" role="tab" aria-controls="overview" 
                                    aria-selected="true">
                                <i class="bi bi-info-circle me-1"></i> Overview
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="members-tab" data-bs-toggle="tab" 
                                    data-bs-target="#members" type="button" role="tab" aria-controls="members" 
                                    aria-selected="false">
                                <i class="bi bi-people me-1"></i> Members ({{ team.members|length }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="activity-tab" data-bs-toggle="tab" 
                                    data-bs-target="#activity" type="button" role="tab" aria-controls="activity" 
                                    aria-selected="false">
                                <i class="bi bi-activity me-1"></i> Activity
                            </button>
                        </li>
                        {% if current_user.id == team.leader_id or current_user.is_admin %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" 
                                    data-bs-target="#settings" type="button" role="tab" aria-controls="settings" 
                                    aria-selected="false">
                                <i class="bi bi-gear me-1"></i> Settings
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="teamTabsContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5>About</h5>
                                    <p class="text-muted">
                                        {{ team.description or 'No description provided.' }}
                                    </p>
                                    
                                    {% if team.skills_needed %}
                                    <h5 class="mt-4">Skills We're Looking For</h5>
                                    <div class="d-flex flex-wrap gap-2 mb-4">
                                        {% for skill in team.skills_needed.split(',') %}
                                            <span class="badge bg-primary">{{ skill.strip() }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    
                                    <h5 class="mt-4">Team Progress</h5>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span>Team Formation</span>
                                            <span>{% if team.members|length >= (event.min_team_size or 1) %}100%{% else %}{{ ((team.members|length / (event.min_team_size or 1)) * 100)|int }}%{% endif %}</span>
                                        </div>
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar bg-success" role="progressbar" 
                                                 style="width: {% if team.members|length >= (event.min_team_size or 1) %}100%{% else %}{{ ((team.members|length / (event.min_team_size or 1)) * 100) }}%{% endif %}" 
                                                 aria-valuenow="{{ team.members|length }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="{{ event.min_team_size or 1 }}">
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            {% if team.members|length >= (event.min_team_size or 1) %}
                                                Team has the minimum required members
                                            {% else %}
                                                {{ (event.min_team_size or 1) - team.members|length }} more member{{ 's' if (event.min_team_size or 2) - team.members|length > 1 else '' }} needed
                                            {% endif %}
                                        </small>
                                    </div>
                                    
                                    {% if event.requires_abstract %}
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span>Abstract Submission</span>
                                            <span>{% if team.abstract_submitted %}Submitted{% else %}Pending{% endif %}</span>
                                        </div>
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar bg-{{ 'success' if team.abstract_submitted else 'warning' }}" 
                                                 role="progressbar" 
                                                 style="width: {% if team.abstract_submitted %}100%{% else %}30%{% endif %}" 
                                                 aria-valuenow="{% if team.abstract_submitted %}100{% else %}30{% endif %}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            {% if team.abstract_submitted %}
                                                Abstract submitted on {{ team.abstract_submitted.strftime('%b %d, %Y') }}
                                            {% else %}
                                                No abstract submitted yet
                                                {% if current_user.id == team.leader_id %}
                                                    <a href="{{ url_for('events.submit_abstract', event_id=event.id, team_id=team.id) }}" class="ms-2">
                                                        Submit Now
                                                    </a>
                                                {% endif %}
                                            {% endif %}
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Quick Stats</h6>
                                            <ul class="list-group list-group-flush">
                                                <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center px-0">
                                                    <span>Team Created</span>
                                                    <span>{{ team.created_at.strftime('%b %d, %Y') }}</span>
                                                </li>
                                                <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center px-0">
                                                    <span>Team Leader</span>
                                                    <span>{{ team.leader.full_name }}</span>
                                                </li>
                                                <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center px-0">
                                                    <span>Members</span>
                                                    <span>{{ team.members|length }}{% if team.max_members %}/{{ team.max_members }}{% endif %}</span>
                                                </li>
                                                {% if event.requires_abstract %}
                                                <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center px-0">
                                                    <span>Abstract Status</span>
                                                    <span class="badge bg-{{ 'success' if team.abstract_submitted else 'warning' }}">
                                                        {{ 'Submitted' if team.abstract_submitted else 'Pending' }}
                                                    </span>
                                                </li>
                                                {% endif %}
                                                <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center px-0">
                                                    <span>Team Status</span>
                                                    <span class="badge bg-{{ 'success' if team.is_active else 'secondary' }}">
                                                        {{ 'Active' if team.is_active else 'Inactive' }}
                                                    </span>
                                                </li>
                                            </ul>
                                            
                                            {% if team.looking_for_members %}
                                            <div class="alert alert-info mt-3 mb-0 py-2 small">
                                                <i class="bi bi-info-circle me-1"></i>
                                                This team is looking for new members.
                                                {% if current_user.id != team.leader_id and current_user not in team.members %}
                                                    <a href="#" class="alert-link ms-1" data-bs-toggle="modal" data-bs-target="#joinRequestModal">
                                                        Request to join
                                                    </a>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    {% if team.join_requests and (current_user.id == team.leader_id or current_user.is_admin) %}
                                    <div class="card mt-3 border-warning">
                                        <div class="card-header bg-warning bg-opacity-10 py-2">
                                            <h6 class="mb-0">
                                                <i class="bi bi-people-fill me-1"></i>
                                                Join Requests ({{ team.join_requests|length }})
                                            </h6>
                                        </div>
                                        <div class="card-body p-0">
                                            <ul class="list-group list-group-flush">
                                                {% for request in team.join_requests %}
                                                <li class="list-group-item">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <h6 class="mb-0">{{ request.user.full_name }}</h6>
                                                            <small class="text-muted">{{ request.user.department }}</small>
                                                        </div>
                                                        <div class="btn-group">
                                                            <button class="btn btn-sm btn-outline-success" 
                                                                    onclick="handleJoinRequest({{ request.id }}, 'approve')">
                                                                <i class="bi bi-check-lg"></i>
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-danger" 
                                                                    onclick="handleJoinRequest({{ request.id }}, 'reject')">
                                                                <i class="bi bi-x-lg"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    {% if request.message %}
                                                    <div class="mt-2 p-2 bg-light rounded small">
                                                        <i class="bi bi-chat-left-text me-1"></i>
                                                        {{ request.message }}
                                                    </div>
                                                    {% endif %}
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Members Tab -->
                        <div class="tab-pane fade" id="members" role="tabpanel" aria-labelledby="members-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Team Members</h5>
                                {% if (current_user.id == team.leader_id or current_user.is_admin) and (not team.max_members or team.members|length < team.max_members) %}
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#inviteMemberModal">
                                    <i class="bi bi-person-plus"></i> Invite Member
                                </button>
                                {% endif %}
                            </div>
                            
                            <div class="row g-4">
                                {% for member in team.members %}
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="d-flex">
                                                <div class="flex-shrink-0">
                                                    <img src="{{ url_for('static', filename='uploads/profiles/' + member.profile_pic) if member.profile_pic 
                                                        else url_for('static', filename='images/default-avatar.png') }}" 
                                                         class="rounded-circle me-3" width="60" height="60" alt="{{ member.full_name }}">
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div>
                                                            <h5 class="mb-1">
                                                                {{ member.full_name }}
                                                                {% if member.id == team.leader_id %}
                                                                    <span class="badge bg-primary ms-1">Leader</span>
                                                                {% endif %}
                                                            </h5>
                                                            <p class="mb-1 text-muted">
                                                                {{ member.department }}
                                                                {% if member.year %}
                                                                    • Year {{ member.year }}
                                                                {% endif %}
                                                            </p>
                                                        </div>
                                                        {% if (current_user.id == team.leader_id or current_user.is_admin) and member.id != current_user.id %}
                                                        <div class="dropdown">
                                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                                    type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                                <i class="bi bi-three-dots-vertical"></i>
                                                            </button>
                                                            <ul class="dropdown-menu dropdown-menu-end">
                                                                {% if member.id != team.leader_id %}
                                                                <li>
                                                                    <a class="dropdown-item" href="#" 
                                                                       onclick="makeTeamLeader({{ member.id }})">
                                                                        Make Team Leader
                                                                    </a>
                                                                </li>
                                                                <li>
                                                                    <a class="dropdown-item text-danger" href="#" 
                                                                       onclick="removeMember({{ member.id }})">
                                                                        Remove from Team
                                                                    </a>
                                                                </li>
                                                                {% endif %}
                                                            </ul>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    {% if member.skills %}
                                                    <div class="mt-2">
                                                        {% for skill in member.skills.split(',')[:5] %}
                                                            <span class="badge bg-light text-dark border me-1 mb-1">{{ skill.strip() }}</span>
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                    
                                                    <div class="mt-2">
                                                        <a href="mailto:{{ member.email }}" class="btn btn-sm btn-outline-primary me-1">
                                                            <i class="bi bi-envelope"></i> Message
                                                        </a>
                                                        <a href="{{ url_for('users.profile', username=member.username) }}" 
                                                           class="btn btn-sm btn-outline-secondary">
                                                            <i class="bi bi-person-lines-fill"></i> View Profile
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                
                                {% if (not team.max_members or team.members|length < team.max_members) %}
                                <div class="col-12">
                                    <div class="card border-dashed">
                                        <div class="card-body text-center p-5">
                                            <i class="bi bi-people display-4 text-muted mb-3"></i>
                                            <h5>Invite More Members</h5>
                                            <p class="text-muted mb-4">
                                                {% if team.max_members %}
                                                    You can add {{ team.max_members - team.members|length }} more member{{ 's' if team.max_members - team.members|length > 1 else '' }} to your team.
                                                {% else %}
                                                    There's no limit to your team size.
                                                {% endif %}
                                            </p>
                                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteMemberModal">
                                                <i class="bi bi-person-plus"></i> Invite Members
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Activity Tab -->
                        <div class="tab-pane fade" id="activity" role="tabpanel" aria-labelledby="activity-tab">
                            <h5 class="mb-4">Team Activity</h5>
                            
                            {% if team_activities %}
                            <div class="timeline">
                                {% for activity in team_activities %}
                                <div class="timeline-item">
                                    <div class="timeline-badge {% if activity.type == 'join' %}bg-success
                                        {% elif activity.type == 'leave' %}bg-danger
                                        {% elif activity.type == 'create' %}bg-primary
                                        {% else %}bg-secondary{% endif %}">
                                        <i class="bi {% if activity.type == 'join' %}bi-person-plus
                                            {% elif activity.type == 'leave' %}bi-person-dash
                                            {% elif activity.type == 'create' %}bi-plus-lg
                                            {% else %}bi-activity{% endif %}"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="d-flex justify-content-between">
                                            <h6 class="mb-1">{{ activity.title }}</h6>
                                            <small class="text-muted">{{ activity.timestamp|timesince }} ago</small>
                                        </div>
                                        <p class="small mb-1">{{ activity.description }}</p>
                                        {% if activity.user %}
                                        <div class="d-flex align-items-center">
                                            <img src="{{ url_for('static', filename='uploads/profiles/' + activity.user.profile_pic) if activity.user.profile_pic 
                                                else url_for('static', filename='images/default-avatar.png') }}" 
                                                 class="rounded-circle me-2" width="24" height="24" 
                                                 alt="{{ activity.user.full_name }}">
                                            <small class="text-muted">{{ activity.user.full_name }}</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <div class="text-muted">
                                    <i class="bi bi-activity" style="font-size: 2rem;"></i>
                                    <p class="mt-3">No activity yet</p>
                                    <p class="small">Team activities will appear here.</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Settings Tab (Visible to team leader/admin only) -->
                        {% if current_user.id == team.leader_id or current_user.is_admin %}
                        <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                            <form id="teamSettingsForm" method="POST" enctype="multipart/form-data">
                                {{ form.hidden_tag() }}
                                
                                <div class="mb-4">
                                    <h5 class="border-bottom pb-2 mb-3">Team Information</h5>
                                    <div class="row g-3">
                                        <div class="col-md-8">
                                            <div class="form-group">
                                                <label for="teamName" class="form-label">Team Name</label>
                                                <input type="text" class="form-control" id="teamName" 
                                                       name="name" value="{{ team.name }}" required>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="maxMembers" class="form-label">Max Members</label>
                                                <input type="number" class="form-control" id="maxMembers" 
                                                       name="max_members" value="{{ team.max_members or '' }}" 
                                                       min="{{ team.members|length }}" 
                                                       max="{{ event.max_team_size or '' }}">
                                                <small class="text-muted">
                                                    {% if event.max_team_size %}
                                                        Maximum allowed by event: {{ event.max_team_size }}
                                                    {% else %}
                                                        No maximum limit set
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="teamDescription" class="form-label">Description</label>
                                                <textarea class="form-control" id="teamDescription" 
                                                          name="description" rows="3">{{ team.description or '' }}</textarea>
                                                <small class="text-muted">Tell others about your team's goals and focus.</small>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="skillsNeeded" class="form-label">Skills Needed</label>
                                                <input type="text" class="form-control" id="skillsNeeded" 
                                                       name="skills_needed" value="{{ team.skills_needed or '' }}"
                                                       placeholder="e.g., Python, Design, Marketing">
                                                <small class="text-muted">Separate skills with commas</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <h5 class="border-bottom pb-2 mb-3">Team Settings</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label class="form-label">Team Visibility</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="visibility" 
                                                           id="visibilityPublic" value="public" 
                                                           {% if team.visibility == 'public' %}checked{% endif %}>
                                                    <label class="form-check-label" for="visibilityPublic">
                                                        <strong>Public</strong> - Anyone can see the team and its members
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="visibility" 
                                                           id="visibilityPrivate" value="private" 
                                                           {% if team.visibility == 'private' %}checked{% endif %}>
                                                    <label class="form-check-label" for="visibilityPrivate">
                                                        <strong>Private</strong> - Only team members can see the team
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="form-group mb-3">
                                                <label class="form-label">Join Policy</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="join_policy" 
                                                           id="joinByRequest" value="request" 
                                                           {% if team.join_policy == 'request' %}checked{% endif %}>
                                                    <label class="form-check-label" for="joinByRequest">
                                                        <strong>By Request</strong> - Users must request to join
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="join_policy" 
                                                           id="joinByInvite" value="invite" 
                                                           {% if team.join_policy == 'invite' %}checked{% endif %}>
                                                    <label class="form-check-label" for="joinByInvite">
                                                        <strong>By Invite Only</strong> - Only invited users can join
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="join_policy" 
                                                           id="joinOpen" value="open" 
                                                           {% if team.join_policy == 'open' %}checked{% endif %}>
                                                    <label class="form-check-label" for="joinOpen">
                                                        <strong>Open</strong> - Anyone can join without approval
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" 
                                                           id="lookingForMembers" name="looking_for_members" 
                                                           {% if team.looking_for_members %}checked{% endif %}>
                                                    <label class="form-check-label" for="lookingForMembers">
                                                        <strong>Looking for Members</strong>
                                                    </label>
                                                </div>
                                                <small class="text-muted">
                                                    Show that your team is open to new members.
                                                </small>
                                            </div>
                                            
                                            <div class="form-group mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" 
                                                           id="isActive" name="is_active" 
                                                           {% if team.is_active %}checked{% endif %}>
                                                    <label class="form-check-label" for="isActive">
                                                        <strong>Team Active</strong>
                                                    </label>
                                                </div>
                                                <small class="text-muted">
                                                    Inactive teams won't be shown in search results.
                                                </small>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="teamColor" class="form-label">Team Color</label>
                                                <input type="color" class="form-control form-control-color" 
                                                       id="teamColor" name="color" 
                                                       value="{{ team.color or '#3498db' }}" 
                                                       title="Choose a team color">
                                            </div>
                                            
                                            <div class="form-group mt-3">
                                                <label for="teamAvatar" class="form-label">Team Avatar</label>
                                                <input class="form-control" type="file" id="teamAvatar" name="avatar" 
                                                       accept="image/*">
                                                <small class="text-muted">Recommended size: 400x400px</small>
                                                
                                                {% if team.avatar %}
                                                <div class="mt-2">
                                                    <img src="{{ url_for('static', filename='uploads/teams/' + team.avatar) }}" 
                                                         class="img-thumbnail mt-2" style="max-width: 150px;" 
                                                         alt="Current avatar">
                                                    <div class="form-check mt-2">
                                                        <input class="form-check-input" type="checkbox" 
                                                               id="removeAvatar" name="remove_avatar">
                                                        <label class="form-check-label" for="removeAvatar">
                                                            Remove current avatar
                                                        </label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" 
                                            onclick="window.location.reload()">
                                        <i class="bi bi-x-lg"></i> Cancel
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save"></i> Save Changes
                                    </button>
                                </div>
                            </form>
                            
                            <hr class="my-4">
                            
                            <div class="card border-danger">
                                <div class="card-header bg-danger bg-opacity-10 text-danger">
                                    <h5 class="mb-0">Danger Zone</h5>
                                </div>
                                <div class="card-body">
                                    <h6>Transfer Ownership</h6>
                                    <p class="text-muted">
                                        Transfer team ownership to another member. You will become a regular member.
                                    </p>
                                    <div class="input-group mb-3" style="max-width: 400px;">
                                        <select class="form-select" id="newTeamLeader">
                                            {% for member in team.members %}
                                                {% if member.id != current_user.id %}
                                                    <option value="{{ member.id }}">
                                                        {{ member.full_name }} ({{ member.email }})
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <button class="btn btn-outline-danger" type="button" 
                                                onclick="transferOwnership()">
                                            Transfer
                                        </button>
                                    </div>
                                    
                                    <hr>
                                    
                                    <h6>Disband Team</h6>
                                    <p class="text-muted">
                                        Permanently delete this team. This action cannot be undone.
                                    </p>
                                    <button class="btn btn-danger" data-bs-toggle="modal" 
                                            data-bs-target="#disbandTeamModal">
                                        <i class="bi bi-trash"></i> Disband Team
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Team Resources -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Team Resources</h5>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addResourceModal">
                        <i class="bi bi-plus-lg"></i> Add
                    </button>
                </div>
                <div class="card-body p-0">
                    {% if team.resources %}
                    <div class="list-group list-group-flush">
                        {% for resource in team.resources %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0">
                                        <i class="bi bi-{{ 'file-earmark-pdf' if resource.type == 'pdf' else 'file-earmark-word' if resource.type == 'doc' else 'file-earmark-text' }} me-2"></i>
                                        {{ resource.name }}
                                    </h6>
                                    <small class="text-muted">
                                        {{ resource.size }} • {{ resource.uploaded_by.full_name }} • {{ resource.uploaded_at|timesince }} ago
                                    </small>
                                </div>
                                <div class="btn-group">
                                    <a href="{{ url_for('teams.download_resource', resource_id=resource.id) }}" 
                                       class="btn btn-sm btn-outline-secondary" title="Download">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    {% if current_user.id == team.leader_id or current_user.id == resource.uploaded_by.id or current_user.is_admin %}
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="deleteResource({{ resource.id }})" 
                                            title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-folder-x" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p class="text-muted mt-2 mb-0">No resources uploaded yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Upcoming Deadlines -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Upcoming Deadlines</h5>
                </div>
                <div class="card-body p-0">
                    {% if event.deadlines %}
                    <div class="list-group list-group-flush">
                        {% for deadline in event.deadlines|sort(attribute='due_date') %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ deadline.title }}</h6>
                                    <small class="text-muted">
                                        Due: {{ deadline.due_date.strftime('%b %d, %Y %I:%M %p') }}
                                    </small>
                                </div>
                                <span class="badge bg-{{ 'success' if deadline.is_complete(team.id) else 'warning' }}">
                                    {{ 'Completed' if deadline.is_complete(team.id) else 'Pending' }}
                                </span>
                            </div>
                            {% if deadline.description %}
                            <p class="mt-2 mb-0 small">{{ deadline.description }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-calendar-check" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p class="text-muted mt-2 mb-0">No upcoming deadlines</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Team Chat -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Team Chat</h5>
                </div>
                <div class="card-body p-0" style="height: 300px; overflow-y: auto;">
                    <div id="teamChat" class="p-3">
                        {% if team.messages %}
                            {% for message in team.messages|sort(attribute='created_at') %}
                            <div class="mb-3">
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <img src="{{ url_for('static', filename='uploads/profiles/' + message.sender.profile_pic) if message.sender.profile_pic 
                                            else url_for('static', filename='images/default-avatar.png') }}" 
                                             class="rounded-circle me-2" width="32" height="32" 
                                             alt="{{ message.sender.full_name }}">
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="bg-light rounded p-2">
                                            <div class="d-flex justify-content-between">
                                                <h6 class="mb-0">{{ message.sender.full_name }}</h6>
                                                <small class="text-muted">{{ message.created_at|timesince }} ago</small>
                                            </div>
                                            <p class="mb-0">{{ message.content }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-5">
                                <i class="bi bi-chat-left-text" style="font-size: 2rem; opacity: 0.5;"></i>
                                <p class="text-muted mt-2 mb-0">No messages yet</p>
                                <p class="small">Start the conversation!</p>
                            </div>
                        {% endif %}
                    </div>
                    <div class="border-top p-2">
                        <form id="chatForm" class="d-flex">
                            <input type="text" class="form-control me-2" id="chatMessage" 
                                   placeholder="Type a message..." required>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Invite Member Modal -->
<div class="modal fade" id="inviteMemberModal" tabindex="-1" aria-labelledby="inviteMemberModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inviteMemberModalLabel">Invite Team Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="inviteMemberForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="inviteEmail" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="inviteEmail" required
                               placeholder="Enter the email address of the person you want to invite">
                        <div class="form-text">The person will receive an email with an invitation to join your team.</div>
                    </div>
                    <div class="mb-3">
                        <label for="inviteMessage" class="form-label">Personal Message (Optional)</label>
                        <textarea class="form-control" id="inviteMessage" rows="3"
                                 placeholder="Add a personal message to include with the invitation"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Invitation</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Join Request Modal -->
<div class="modal fade" id="joinRequestModal" tabindex="-1" aria-labelledby="joinRequestModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="joinRequestModalLabel">Request to Join Team</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="joinRequestForm">
                <div class="modal-body">
                    <p>You're requesting to join <strong>{{ team.name }}</strong>.</p>
                    <div class="mb-3">
                        <label for="requestMessage" class="form-label">Message (Optional)</label>
                        <textarea class="form-control" id="requestMessage" name="message" rows="3"
                                 placeholder="Tell the team leader why you want to join"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                        <label class="form-check-label" for="agreeTerms">
                            I understand that I'll leave my current team if I join this one.
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Request</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Disband Team Modal -->
<div class="modal fade" id="disbandTeamModal" tabindex="-1" aria-labelledby="disbandTeamModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="disbandTeamModalLabel">Disband Team</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone. All team data will be permanently deleted.
                </div>
                <p>Are you sure you want to disband the team <strong>{{ team.name }}</strong>?</p>
                <p>This will:</p>
                <ul>
                    <li>Remove all team members</li>
                    <li>Delete all team resources and messages</li>
                    <li>Cancel all pending invitations and join requests</li>
                    <li>Remove the team from the event</li>
                </ul>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmDisband">
                    <label class="form-check-label" for="confirmDisband">
                        I understand that this action cannot be undone
                    </label>
                </div>
                <div class="form-group">
                    <label for="disbandReason" class="form-label">Reason for disbanding (optional)</label>
                    <textarea class="form-control" id="disbandReason" rows="2"
                              placeholder="Let your team members know why you're disbanding the team"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDisbandBtn" disabled>
                    <i class="bi bi-trash"></i> Disband Team
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Resource Modal -->
<div class="modal fade" id="addResourceModal" tabindex="-1" aria-labelledby="addResourceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addResourceModalLabel">Add Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addResourceForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="resourceFile" class="form-label">File</label>
                        <input class="form-control" type="file" id="resourceFile" name="file" required>
                        <div class="form-text">Maximum file size: 10MB. Allowed formats: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, TXT, ZIP</div>
                    </div>
                    <div class="mb-3">
                        <label for="resourceName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="resourceName" name="name" required>
                        <div class="form-text">A descriptive name for this resource</div>
                    </div>
                    <div class="mb-3">
                        <label for="resourceDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="resourceDescription" name="description" rows="2"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="resourceIsPublic" name="is_public">
                        <label class="form-check-label" for="resourceIsPublic">
                            Make this resource visible to all team members
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle recruitment status
        const toggleRecruitment = document.getElementById('toggleRecruitment');
        if (toggleRecruitment) {
            toggleRecruitment.addEventListener('click', function(e) {
                e.preventDefault();
                const newStatus = this.getAttribute('data-status') === '1';
                
                fetch('{{ url_for("teams.update_recruitment_status", team_id=team.id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({
                        looking_for_members: newStatus
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert(data.message || 'An error occurred');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating the recruitment status');
                });
            });
        }
        
        // Handle join requests (approve/reject)
        window.handleJoinRequest = function(requestId, action) {
            if (!confirm(`Are you sure you want to ${action} this join request?`)) {
                return;
            }
            
            fetch(`/teams/join-request/${requestId}/${action}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.message || 'An error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while processing the request');
            });
        };
        
        // Transfer team ownership
        window.transferOwnership = function() {
            const newLeaderId = document.getElementById('newTeamLeader').value;
            if (!confirm('Are you sure you want to transfer team leadership? You will become a regular member.')) {
                return;
            }
            
            fetch('{{ url_for("teams.transfer_ownership", team_id=team.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    new_leader_id: newLeaderId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.message || 'An error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while transferring ownership');
            });
        };
        
        // Remove team member
        window.removeMember = function(memberId) {
            if (!confirm('Are you sure you want to remove this member from the team?')) {
                return;
            }
            
            fetch('{{ url_for("teams.remove_member", team_id=team.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    member_id: memberId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.message || 'An error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while removing the member');
            });
        };
        
        // Make team leader
        window.makeTeamLeader = function(memberId) {
            if (!confirm('Are you sure you want to make this member the new team leader?')) {
                return;
            }
            
            fetch('{{ url_for("teams.make_leader", team_id=team.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    member_id: memberId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.message || 'An error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating team leadership');
            });
        };
        
        // Delete resource
        window.deleteResource = function(resourceId) {
            if (!confirm('Are you sure you want to delete this resource? This action cannot be undone.')) {
                return;
            }
            
            fetch(`/teams/resource/${resourceId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.message || 'An error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the resource');
            });
        };
        
        // Confirm disband team
        const confirmDisband = document.getElementById('confirmDisband');
        const confirmDisbandBtn = document.getElementById('confirmDisbandBtn');
        
        if (confirmDisband && confirmDisbandBtn) {
            confirmDisband.addEventListener('change', function() {
                confirmDisbandBtn.disabled = !this.checked;
            });
            
            confirmDisbandBtn.addEventListener('click', function() {
                const reason = document.getElementById('disbandReason').value;
                
                fetch('{{ url_for("teams.disband", team_id=team.id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({
                        reason: reason
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = data.redirect_url || '{{ url_for("events.view_event", event_id=event.id) }}';
                    } else {
                        alert(data.message || 'An error occurred while disbanding the team');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while disbanding the team');
                });
            });
        }
        
        // Chat functionality
        const chatForm = document.getElementById('chatForm');
        const chatMessage = document.getElementById('chatMessage');
        const teamChat = document.getElementById('teamChat');
        
        if (chatForm && chatMessage && teamChat) {
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const message = chatMessage.value.trim();
                if (!message) return;
                
                // Add message to chat immediately (optimistic update)
                const messageHtml = `
                    <div class="mb-3">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <img src="{{ url_for('static', filename='uploads/profiles/' + current_user.profile_pic) if current_user.profile_pic 
                                    else url_for('static', filename='images/default-avatar.png') }}" 
                                     class="rounded-circle me-2" width="32" height="32" 
                                     alt="{{ current_user.full_name }}">
                            </div>
                            <div class="flex-grow-1">
                                <div class="bg-light rounded p-2">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-0">{{ current_user.full_name }}</h6>
                                        <small class="text-muted">Just now</small>
                                    </div>
                                    <p class="mb-0">${message}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                teamChat.insertAdjacentHTML('beforeend', messageHtml);
                chatMessage.value = '';
                teamChat.scrollTop = teamChat.scrollHeight;
                
                // Send message to server
                fetch('{{ url_for("teams.send_message", team_id=team.id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({
                        content: message
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('Failed to send message:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                });
            });
            
            // Auto-scroll to bottom of chat
            teamChat.scrollTop = teamChat.scrollHeight;
        }
        
        // File upload preview
        const fileInput = document.getElementById('resourceFile');
        const fileNameDisplay = document.getElementById('fileName');
        
        if (fileInput && fileNameDisplay) {
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    fileNameDisplay.textContent = this.files[0].name;
                } else {
                    fileNameDisplay.textContent = 'No file chosen';
                }
            });
        }
    });
</script>
{% endblock %}
