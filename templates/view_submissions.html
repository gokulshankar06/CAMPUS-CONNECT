{% extends '_base.html' %}

{% block title %}Submissions · {{ assignment.title }} · CampusConnect{% endblock %}

{% block head_extra %}
<style>
  .surface { background: var(--card-bg, var(--gray-50)); color: var(--card-fg, var(--gray-900)); border: 1px solid var(--card-border, var(--gray-200)); }
  .muted { color: var(--muted-color, var(--gray-600)); }
  .divider { border-top: 1px solid var(--divider, var(--gray-300)); }

  @media (prefers-color-scheme: dark) {
    .surface { background: var(--card-bg-dark, #1f2937); color: #e5e7eb; border-color: #374151; }
    .muted { color: #9ca3af; }
    .divider { border-color: #4b5563; }
    /* Adjust pastel feedback backgrounds for dark mode */
    .bg-red-100 { background: #7f1d1d !important; color: #fecaca; border-color: #ef4444; }
    .bg-yellow-100 { background: #78350f !important; color: #fde68a; border-color: #f59e0b; }
    .bg-green-100 { background: #064e3b !important; color: #bbf7d0; border-color: #10b981; }
    /* Slate utility overrides commonly used in this template */
    .text-slate-700 { color: #e5e7eb !important; }
    .border-slate-300 { border-color: #475569 !important; }
    .bg-slate-100 { background: #0f172a !important; }
  }
</style>
{% endblock %}

{% block content %}
  <header class="header" role="banner">
    <h1 class="header-title header-title--sharp">Submissions for "{{ assignment.title }}"</h1>
    <div class="flex items-center justify-center gap-3 mb-2">
      <span class="inline-flex items-center gap-2 text-sm font-semibold text-slate-700 bg-slate-100 border border-slate-300 px-3 py-1 rounded-full">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-slate-600"><path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 15h-2v-2h2Zm0-4h-2V7h2Z"/></svg>
        Assignment ID: <span class="font-bold">#{{ assignment.id }}</span>
      </span>
    </div>
    <nav class="nav" role="navigation" aria-label="Primary">
      <a href="{{ url_for('faculty.faculty_assignments') }}">Back to My Assignments</a>
      <a href="{{ url_for('auth.logout') }}" class="text-red-600">Logout</a>
    </nav>
  </header>

  <main class="container" role="main">
    <h2 class="text-center mb-6">Submissions</h2>

    <form method="GET" class="max-w-2xl mx-auto mb-6 flex items-center gap-3">
      <input type="hidden" name="page" value="1" />
      <input name="q" value="{{ q or '' }}" placeholder="Search by student or content..." class="flex-1 border border-slate-300 rounded-lg p-2" />
      <button class="btn btn-secondary" type="submit"><i class="fas fa-search"></i> Search</button>
      {% if q %}
        <a href="{{ url_for('faculty.view_submissions', assignment_id=assignment.id) }}" class="muted hover:underline">Clear</a>
      {% endif %}
    </form>

    <div class="space-y-6">
      {% if not submissions_with_reports %}
        <p class="muted text-center italic">No submissions have been made for this assignment yet.</p>
      {% else %}
        {% for sub_report in submissions_with_reports %}
          <div class="surface p-6 rounded-lg shadow-md">
            <h3 class="card-title">Submission by: {{ sub_report.submission.username }}</h3>
            <p class="muted mt-2">
              {{ (sub_report.submission.content[:240] ~ ('…' if sub_report.submission.content|length > 240 else '')) if sub_report.submission.content else 'No content provided.' }}
            </p>
            <div class="mt-3 flex flex-wrap gap-3">
              <a href="{{ url_for('faculty.submission_detail', submission_id=sub_report.submission.id) }}" class="btn btn-primary">
                <i class="fas fa-arrow-right"></i> View Details & Grade
              </a>
              {% if sub_report.submission.file_name %}
                <a href="{{ url_for('faculty.view_submission_file', submission_id=sub_report.submission.id) }}" class="btn btn-secondary">
                  <i class="fas fa-file"></i> View File
                </a>
                <a href="{{ url_for('faculty.download_submission', submission_id=sub_report.submission.id) }}" class="btn btn-success">
                  <i class="fas fa-download"></i> Download Original
                </a>
              {% else %}
                <a href="{{ url_for('faculty.download_submission', submission_id=sub_report.submission.id) }}" class="btn btn-secondary">
                  <i class="fas fa-download"></i> Download .txt
                </a>
              {% endif %}
              {% if sub_report.submission.grade is not none %}
                <span class="inline-flex items-center gap-2 bg-emerald-100 text-emerald-700 font-semibold py-2 px-3 rounded-lg">
                  Grade: {{ sub_report.submission.grade }}/100
                </span>
              {% else %}
                <span class="inline-flex items-center gap-2 bg-amber-100 text-amber-700 font-semibold py-2 px-3 rounded-lg">
                  Not graded
                </span>
              {% endif %}
            </div>

            <div class="mt-4 divider pt-4">
              <h4 class="text-lg font-bold">Plagiarism Report:</h4>
              <div class="mt-2 p-4 rounded-lg
                {% if sub_report.overall_similarity > 60 %} bg-red-100 border-l-4 border-red-500
                {% elif sub_report.overall_similarity > 20 %} bg-yellow-100 border-l-4 border-yellow-500
                {% else %} bg-green-100 border-l-4 border-green-500 {% endif %}">
                <p class="font-bold text-lg">Overall Similarity Score: {{ sub_report.overall_similarity }}%</p>
                {% if sub_report.plagiarism_report %}
                  <p class="mt-2">Details of sources with significant similarity:</p>
                  <ul class="list-disc list-inside mt-2 space-y-1">
                    {% for item in sub_report.plagiarism_report %}
                      <li>{{ item.similarity }} match with another submission by <strong>{{ item.source_user }}</strong>.</li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p class="mt-2">No significant similarity found with other submissions for this assignment.</p>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    {% if total_pages and total_pages > 1 %}
      <nav class="mt-8 flex items-center justify-center gap-2" aria-label="Pagination">
        {% set prev_page = page - 1 %}
        {% set next_page = page + 1 %}
        <a class="px-3 py-2 rounded border border-slate-300 text-slate-700 {{ 'pointer-events-none opacity-50' if page <= 1 else '' }}" href="{{ url_for('faculty.view_submissions', assignment_id=assignment.id, page=prev_page, q=q) }}">Prev</a>
        {% for p in range(1, total_pages + 1) %}
          <a class="px-3 py-2 rounded border {{ 'bg-blue-600 text-white border-blue-600' if p == page else 'border-slate-300 text-slate-700' }}" href="{{ url_for('faculty.view_submissions', assignment_id=assignment.id, page=p, q=q) }}">{{ p }}</a>
        {% endfor %}
        <a class="px-3 py-2 rounded border border-slate-300 text-slate-700 {{ 'pointer-events-none opacity-50' if page >= total_pages else '' }}" href="{{ url_for('faculty.view_submissions', assignment_id=assignment.id, page=next_page, q=q) }}">Next</a>
      </nav>
    {% endif %}
  </main>
{% endblock %}

{% block scripts_extra %}
  <script src="{{ url_for('static', filename='darkmode.js') }}"></script>
{% endblock %}